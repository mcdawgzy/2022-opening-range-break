
#region imports
from AlgorithmImports import *
#endregion
# Range Breakout

class RangeBreakout(QCAlgorithm):

    def Initialize(self):
        # Set Dates
        self.SetStartDate(2017,9,1)
        self.SetEndDate(2020,9,1)  

        # Set Cash
        self.SetCash(100000) 

        # Set Stock
        self.symbol = self.AddEquity("SPY", Resolution.Daily).Symbol
        
        # Set lookback period
        self.lookback = 20

        # Set stop loss figures
        self.longinitialStopRisk = 0.98
        self.longtrailingStopRisk = 0.9
        self.shortinitialStopRisk = 1.02
        self.shorttrailingStopRisk = 1.1
        self.highestPrice = 0
        self.lowestPrice = 0        

        # Schedule function 20 minutes after every market open
        self.Schedule.On(self.DateRules.EveryDay(self.symbol), self.TimeRules.AfterMarketOpen(self.symbol, 20), Action(self.EveryMarketOpen))

    def OnData(self, data):
        self.Plot("Data Chart", self.symbol, self.Securities[self.symbol].Close)

    def EveryMarketOpen(self):
        # List of daily highs and lows
        self.high = self.History(self.symbol, self.lookback, Resolution.Daily)["high"]
        self.low = self.History(self.symbol, self.lookback, Resolution.Daily)["low"]
        
        # Buy in case of high breakout
        if not self.Securities[self.symbol].Invested and self.Securities[self.symbol].Close >= max(self.high[:-1]):
            self.SetHoldings(self.symbol, 1)
            self.breakoutlvl = max(self.high[:-1])
            self.highestPrice = self.breakoutlvl   

        # Sell in case of low breakout
        if not self.Securities[self.symbol].Invested and self.Securities[self.symbol].Close <= min(self.low[:-1]):
            self.SetHoldings(self.symbol, -1)
            self.breakoutlvl = min(self.low[:-1])
            self.lowestPrice = self.breakoutlvl
        
        # Create trailing stop loss if invested 
        if self.Securities[self.symbol].Invested:
            
            # If no order exists, send stop-loss
            if not self.Transactions.GetOpenOrders(self.symbol) and self.Securities[self.symbol].Close >= max(self.high[:-1]):
                self.stopMarketTicket = self.StopMarketOrder(self.symbol, \
                                        -self.Portfolio[self.symbol].Quantity, \
                                        self.longinitialStopRisk * self.breakoutlvl)

            if not self.Transactions.GetOpenOrders(self.symbol) and self.Securities[self.symbol].Close <= min(self.low[:-1]):
                self.stopMarketTicket = self.StopMarketOrder(self.symbol, \
                                        -self.Portfolio[self.symbol].Quantity, \
                                        self.shortinitialStopRisk * self.breakoutlvl)
          
            # Check if the asset's price is higher than highestPrice & trailing stop price not below initial stop price
            if self.Securities[self.symbol].Close > self.highestPrice and \
                    self.longinitialStopRisk * self.breakoutlvl < self.Securities[self.symbol].Close * self.longtrailingStopRisk:
                # Save the new high to highestPrice
                self.highestPrice = self.Securities[self.symbol].Close
                # Update the stop price
                updateFields = UpdateOrderFields()
                updateFields.StopPrice = self.Securities[self.symbol].Close * self.longtrailingStopRisk
                self.stopMarketTicket.Update(updateFields)
                
                # Print the new stop price with Debug()
                self.Debug(updateFields.StopPrice)

            # Check if the asset's price is lower than lowestPrice & trailing stop price not above initial stop price
            if self.Securities[self.symbol].Close < self.lowestPrice and \
                    self.shortinitialStopRisk * self.breakoutlvl > self.Securities[self.symbol].Close * self.shorttrailingStopRisk:
                # Save the new high to lowestPrice
                self.lowestPrice = self.Securities[self.symbol].Close
                # Update the stop price
                updateFields = UpdateOrderFields()
                updateFields.StopPrice = self.Securities[self.symbol].Close * self.shorttrailingStopRisk
                self.stopMarketTicket.Update(updateFields)
                
                # Print the new stop price with Debug()
                self.Debug(updateFields.StopPrice)
            
            # Plot trailing stop's price
            self.Plot("Data Chart", "Stop Price", self.stopMarketTicket.Get(OrderField.StopPrice))
