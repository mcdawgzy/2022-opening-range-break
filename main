class OpeningRangeBreakout(QCAlgorithm):

    openingBar = None 
    
    def Initialize(self):
        self.SetStartDate(2021, 1, 30)  
        self.SetEndDate(2021, 12, 15)  
        self.SetCash(10000)
        self.AddEquity("SPY", Resolution.Minute)
        self.Consolidate("SPY", timedelta(minutes=30), self.OnDataConsolidated)
        
        self.Schedule.On(self.DateRules.EveryDay("SPY"), self.TimeRules.At(13, 30), self.ClosePositions)
        
    def OnData(self, data):
        
        if self.Portfolio.Invested or self.openingBar is None:
            return
        
        if data["SPY"].Close > self.openingBar.High:
            self.SetHoldings("SPY", 1)

        elif data["SPY"].Close < self.openingBar.Low:
            self.SetHoldings("SPY", -1)  
         
    def OnDataConsolidated(self, bar):
        if bar.Time.hour == 9 and bar.Time.minute == 30:
            self.openingBar = bar
    
    def ClosePositions(self):
        self.openingBar = None
        self.Liquidate("SPY")
        
