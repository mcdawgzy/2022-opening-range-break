#region imports
from AlgorithmImports import *
#endregion
# Range Breakout

# ------------------------------------------------------------
STOCK = "SPY"; PERIOD = 20
# ------------------------------------------------------------

class RangeBreakout(QCAlgorithm):

    def Initialize(self):
        # Set Dates
        self.SetStartDate(2022,5,10)
        self.SetEndDate(2022,5,11)

        # Set Cash
        self.SetCash(100000)

        # Add Asset
        self.symbol = self.AddEquity(STOCK, Resolution.Minute).Symbol

        # Add Donchian Channel
        self.dch = self.DCH(STOCK, 20)

        # Set WarmUp Period
        self.SetWarmUp(PERIOD + 1, Resolution.Minute)

        # If stop loss is not hit, liquidate positions 5 mins before close
        self.Schedule.On(self.DateRules.EveryDay(self.symbol), self.TimeRules.BeforeMarketClose(self.symbol, 5), self.Liquidate)

    def OnData(self, data):
        if self.IsWarmingUp:
            return

        if self.Time.hour < 13 or self.Time.hour >= 16: 
            return
        
        # Set risk parameters
        price = self.Securities[self.symbol].Price
        risk = self.Portfolio.TotalPortfolioValue / 400

        # Set Donchian Channel parameters
        donchUpper = self.dch.UpperBand.Current.Value
        donchLower = self.dch.LowerBand.Current.Value
        donchBasis = (donchLower + (donchUpper - donchLower)/2)
        donchRange = donchUpper - donchLower

        # Calculate Dynamic Order Size
        shareqty = Math.Round(risk / donchRange)

        # If portfolio not invested and price touches upper band, buy with stop loss at middle band
        if not self.Portfolio.Invested and price > donchUpper:
            self.MarketOrder(STOCK, shareqty)

            
        # If portfolio not invested and price touches lower band, sell
        if not self.Portfolio.Invested and price < donchLower:
            self.MarketOrder(STOCK, -shareqty)

        # If portfolio invested and long
        if self.Portfolio.Invested and self.Portfolio[self.symbol].Quantity > 0:
            # Set trailing long stop loss
            if price < donchBasis:
                self.Liquidate(tag="Long SL")

        # If portfolio invested and short
        if self.Portfolio.Invested and self.Portfolio[self.symbol].Quantity < 0:
            # Set trailing short stop loss
            if price > donchBasis:
                self.Liquidate(tag="Short SL")
                
